<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geteilte Einkaufsliste</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icons as SVG components
        const Plus = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Trash2 = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const Check = ({ size = 16 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        );

        const Settings = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m0-18l-2.5 2.5M12 1l2.5 2.5M1 12h6m6 0h6M1 12l2.5-2.5M1 12l2.5 2.5m18.5-2.5l-2.5-2.5m2.5 2.5l-2.5 2.5M12 23l-2.5-2.5M12 23l2.5-2.5"></path>
            </svg>
        );

        const X = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const Wifi = ({ size = 64 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
                <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
                <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                <line x1="12" y1="20" x2="12.01" y2="20"></line>
            </svg>
        );

        const ShoppingList = () => {
            const [items, setItems] = useState([]);
            const [newItem, setNewItem] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [firebaseConfig, setFirebaseConfig] = useState(null);
            const [tempConfig, setTempConfig] = useState({
                apiKey: '',
                authDomain: '',
                databaseURL: '',
                projectId: '',
                storageBucket: '',
                messagingSenderId: '',
                appId: ''
            });
            const [connected, setConnected] = useState(false);
            const [database, setDatabase] = useState(null);
            const [error, setError] = useState('');
            const [user, setUser] = useState(null);
            const [signingIn, setSigningIn] = useState(false);

            useEffect(() => {
                const savedConfig = localStorage.getItem('firebaseConfig');
                if (savedConfig) {
                    try {
                        const config = JSON.parse(savedConfig);
                        setFirebaseConfig(config);
                        setTempConfig(config);
                        initFirebase(config);
                    } catch (e) {
                        console.error('Fehler beim Laden der Config:', e);
                    }
                }
            }, []);

            const initFirebase = (config) => {
                try {
                    // Initialisiere Firebase
                    if (!firebase.apps.length) {
                        firebase.initializeApp(config);
                    }
                    
                    const db = firebase.database();
                    const auth = firebase.auth();
                    
                    setDatabase(db);

                    // Auth State Listener
                    auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            setUser(user);
                            setConnected(true);
                            setError('');
                            setupRealtimeListener(db);
                        } else {
                            // Anonyme Anmeldung
                            setSigningIn(true);
                            try {
                                await auth.signInAnonymously();
                            } catch (e) {
                                console.error('Anmeldefehler:', e);
                                setError('Anmeldefehler: ' + e.message);
                                setSigningIn(false);
                            }
                        }
                    });

                } catch (e) {
                    console.error('Firebase Fehler:', e);
                    setError('Fehler bei der Verbindung: ' + e.message);
                    setConnected(false);
                }
            };

            const setupRealtimeListener = (db) => {
                // Echtzeit-Listener für Items
                const itemsRef = db.ref('items');
                itemsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const itemsList = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                        setItems(itemsList);
                    } else {
                        setItems([]);
                    }
                    setSigningIn(false);
                });
            };

            const saveSettings = () => {
                localStorage.setItem('firebaseConfig', JSON.stringify(tempConfig));
                setFirebaseConfig(tempConfig);
                setShowSettings(false);
                initFirebase(tempConfig);
            };

            const addItem = async () => {
                if (!newItem.trim() || !database) return;

                try {
                    const itemsRef = database.ref('items');
                    const newItemRef = itemsRef.push();
                    
                    await newItemRef.set({
                        name: newItem.trim(),
                        checked: false,
                        timestamp: Date.now()
                    });

                    setNewItem('');
                } catch (e) {
                    console.error('Fehler beim Hinzufügen:', e);
                    setError('Fehler beim Hinzufügen');
                }
            };

            const toggleItem = async (id) => {
                if (!database) return;

                try {
                    const itemRef = database.ref(`items/${id}`);
                    const snapshot = await itemRef.once('value');
                    const item = snapshot.val();
                    
                    await itemRef.update({
                        checked: !item.checked,
                        timestamp: Date.now()
                    });
                } catch (e) {
                    console.error('Fehler beim Aktualisieren:', e);
                }
            };

            const deleteItem = async (id) => {
                if (!database) return;

                try {
                    await database.ref(`items/${id}`).remove();
                } catch (e) {
                    console.error('Fehler beim Löschen:', e);
                }
            };

            const clearChecked = async () => {
                if (!database) return;

                try {
                    const checkedItems = items.filter(item => item.checked);
                    const updates = {};
                    checkedItems.forEach(item => {
                        updates[`items/${item.id}`] = null;
                    });
                    await database.ref().update(updates);
                } catch (e) {
                    console.error('Fehler beim Löschen:', e);
                }
            };

            if (showSettings) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                        <div className="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold text-gray-800">Firebase Einstellungen</h2>
                                <button onClick={() => setShowSettings(false)} className="text-gray-500 hover:text-gray-700">
                                    <X size={24} />
                                </button>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                                    <input
                                        type="text"
                                        value={tempConfig.apiKey}
                                        onChange={(e) => setTempConfig({...tempConfig, apiKey: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                        placeholder="AIza..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Auth Domain</label>
                                    <input
                                        type="text"
                                        value={tempConfig.authDomain}
                                        onChange={(e) => setTempConfig({...tempConfig, authDomain: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                        placeholder="projekt-id.firebaseapp.com"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Database URL</label>
                                    <input
                                        type="text"
                                        value={tempConfig.databaseURL}
                                        onChange={(e) => setTempConfig({...tempConfig, databaseURL: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                        placeholder="https://projekt-id.firebaseio.com"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Project ID</label>
                                    <input
                                        type="text"
                                        value={tempConfig.projectId}
                                        onChange={(e) => setTempConfig({...tempConfig, projectId: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                        placeholder="projekt-id"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Storage Bucket</label>
                                    <input
                                        type="text"
                                        value={tempConfig.storageBucket}
                                        onChange={(e) => setTempConfig({...tempConfig, storageBucket: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                        placeholder="projekt-id.appspot.com"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Messaging Sender ID</label>
                                    <input
                                        type="text"
                                        value={tempConfig.messagingSenderId}
                                        onChange={(e) => setTempConfig({...tempConfig, messagingSenderId: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                        placeholder="123456789"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">App ID</label>
                                    <input
                                        type="text"
                                        value={tempConfig.appId}
                                        onChange={(e) => setTempConfig({...tempConfig, appId: e.target.value})}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                        placeholder="1:123456789:web:abc..."
                                    />
                                </div>

                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-gray-700">
                                    <p className="font-semibold mb-2">Setup-Anleitung:</p>
                                    <ol className="list-decimal list-inside space-y-1">
                                        <li>Gehe zu <a href="https://console.firebase.google.com" target="_blank" className="text-blue-600 underline">Firebase Console</a></li>
                                        <li>Erstelle ein neues Projekt</li>
                                        <li>Füge eine Web-App hinzu</li>
                                        <li>Aktiviere "Realtime Database"</li>
                                        <li>Gehe zu "Authentication" → "Sign-in method" → Aktiviere "Anonymous"</li>
                                        <li>In "Realtime Database" → "Rules" füge diese Regeln ein:</li>
                                    </ol>
                                    <pre className="bg-gray-800 text-green-400 p-3 rounded mt-2 text-xs overflow-x-auto">
{`{
  "rules": {
    "items": {
      ".read": "auth != null",
      ".write": "auth != null"
    }
  }
}`}
                                    </pre>
                                </div>

                                <button
                                    onClick={saveSettings}
                                    className="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors"
                                >
                                    Speichern und Verbinden
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!firebaseConfig) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="max-w-md bg-white rounded-2xl shadow-xl p-8 text-center">
                            <Wifi size={64} className="mx-auto mb-4 text-blue-500" />
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">Willkommen!</h2>
                            <p className="text-gray-600 mb-6">
                                Bitte konfiguriere zuerst deine Firebase-Verbindung für Echtzeit-Synchronisation.
                            </p>
                            <button
                                onClick={() => setShowSettings(true)}
                                className="bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors"
                            >
                                Firebase einrichten
                            </button>
                        </div>
                    </div>
                );
            }

            if (signingIn) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="max-w-md bg-white rounded-2xl shadow-xl p-8 text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Verbinde...</h2>
                            <p className="text-gray-600">Anonyme Anmeldung läuft</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 pb-20">
                    <div className="max-w-md mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
                            <div className="bg-gradient-to-r from-blue-500 to-indigo-600 p-6 text-white">
                                <div className="flex justify-between items-center">
                                    <h1 className="text-2xl font-bold">Einkaufsliste</h1>
                                    <button
                                        onClick={() => setShowSettings(true)}
                                        className="p-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition-all"
                                    >
                                        <Settings size={20} />
                                    </button>
                                </div>
                                <div className="flex items-center gap-2 mt-2">
                                    <div className={`w-2 h-2 rounded-full ${connected ? 'bg-green-300' : 'bg-red-300'}`}></div>
                                    <p className="text-xs text-blue-100">
                                        {connected ? 'Echtzeit verbunden' : 'Nicht verbunden'}
                                    </p>
                                </div>
                                {error && (
                                    <p className="text-xs mt-2 text-red-200 bg-red-500 bg-opacity-30 px-2 py-1 rounded">
                                        {error}
                                    </p>
                                )}
                            </div>

                            <div className="p-4">
                                <div className="flex gap-2 mb-4">
                                    <input
                                        type="text"
                                        value={newItem}
                                        onChange={(e) => setNewItem(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && addItem()}
                                        placeholder="Neues Produkt..."
                                        className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        disabled={!connected}
                                    />
                                    <button
                                        onClick={addItem}
                                        disabled={!connected || !newItem.trim()}
                                        className="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        <Plus />
                                    </button>
                                </div>

                                <div className="space-y-2">
                                    {items
                                        .sort((a, b) => {
                                            if (a.checked !== b.checked) {
                                                return a.checked ? 1 : -1;
                                            }
                                            return b.timestamp - a.timestamp;
                                        })
                                        .map((item) => (
                                        <div
                                            key={item.id}
                                            className={`flex items-center gap-3 p-3 rounded-lg border-2 transition-all ${
                                                item.checked
                                                    ? 'bg-green-50 border-green-200'
                                                    : 'bg-white border-gray-200 hover:border-blue-300'
                                            }`}
                                        >
                                            <button
                                                onClick={() => toggleItem(item.id)}
                                                disabled={!connected}
                                                className={`flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${
                                                    item.checked
                                                        ? 'bg-green-500 border-green-500'
                                                        : 'border-gray-300 hover:border-blue-500'
                                                }`}
                                            >
                                                {item.checked && <Check size={16} className="text-white" />}
                                            </button>
                                            <span
                                                className={`flex-1 ${
                                                    item.checked ? 'line-through text-gray-500' : 'text-gray-800'
                                                }`}
                                            >
                                                {item.name}
                                            </span>
                                            <button
                                                onClick={() => deleteItem(item.id)}
                                                disabled={!connected}
                                                className="text-red-500 hover:text-red-700 transition-colors disabled:opacity-50"
                                            >
                                                <Trash2 size={20} />
                                            </button>
                                        </div>
                                    ))}
                                </div>

                                {items.length === 0 && (
                                    <div className="text-center py-12 text-gray-400">
                                        <p>Keine Produkte auf der Liste</p>
                                        <p className="text-sm">Füge dein erstes Produkt hinzu!</p>
                                    </div>
                                )}

                                {items.some(item => item.checked) && (
                                    <button
                                        onClick={clearChecked}
                                        disabled={!connected}
                                        className="w-full mt-4 bg-red-50 text-red-600 py-3 rounded-lg font-semibold hover:bg-red-100 transition-colors disabled:opacity-50"
                                    >
                                        Gekaufte Produkte löschen ({items.filter(i => i.checked).length})
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<ShoppingList />, document.getElementById('root'));
    </script>
</body>
</html>
